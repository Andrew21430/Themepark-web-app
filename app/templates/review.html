{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">

    <h2>Write a review</h2>
  
  {% if not g.user %}
    <div style="background: #ffeaea; color: #b30000; padding: 1em; border-radius: 8px; font-size: 1.2em; margin-bottom: 2em;">
      You must <a href="{{ url_for('login') }}">log in</a> to write a review.
    </div>
  {% endif %}
  
  {# Review Form: Only show if logged in #}
  {% if g.user %}
    <div class="review-card-2024" style="margin-bottom:2em;">
      <div class="review-main">
        <h4 style="font-family:'Quintessential',serif;margin-top:0;margin-bottom:1em;">
          {{ "Edit Review" if editing else "New Review" }}
        </h4>
        <form method="POST">
          {{ form.hidden_tag() }}

          <div class="mb-3">
            {{ form.content.label(class="form-label") }}
            {{ form.content(class="form-control") }}
          </div>

          <div class="mb-3">
            {{ form.rating.label(class="form-label") }}
            {{ form.rating(class="form-control") }}
          </div>

          <div class="mb-3">
            {{ form.ride_id.label(class="form-label") }}
            {{ form.ride_id(class="form-select") }}
          </div>

          <div class="mb-3">
            {{ form.park_id.label(class="form-label") }}
            {{ form.park_id(class="form-select") }}
          </div>

          <button type="submit" class="review-action-btn-2024 review-action-btn-edit" style="margin-top:1em;">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-pencil" width="23" height="23" viewBox="0 0 24 24" fill="none" stroke="#2070be" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
            {{ "Update Review" if editing else "Submit Review" }}
          </button>
          {% if editing %}
            <a href="{{ url_for('review_page') }}" class="review-action-btn-2024 review-action-btn-delete" style="margin-top:1em;">
              Cancel
            </a>
          {% endif %}
        </form>
      </div>
    </div>
  {% endif %}

  <form method="get" class="search-form-themepark" style="margin-bottom:2em;">
  {{ search_form.hidden_tag() }}

  {{ search_form.search.label }} {{ search_form.search(size=18) }}

  {{ search_form.ride_id.label }} {{ search_form.ride_id() }}

  {{ search_form.park_id.label }} {{ search_form.park_id() }}

  {{ search_form.username.label }} {{ search_form.username(size=12) }}

  {{ search_form.submit(class="search-btn-themepark") }}
</form>
  <h2>All Reviews</h2>

  {% for review in reviews %}
    <div class="review-card-2024">
      <div class="review-main">
        <div class="review-rating-row">
          {% for i in range(review.rating) %}
            <span class="star">&#9733;</span>
          {% endfor %}
          {% for i in range(5 - review.rating) %}
            <span class="star star-empty">&#9733;</span>
          {% endfor %}
          <span style="font-size:1.3em; color:#333; margin-left:.2em;">({{ review.rating }})</span>
        </div>
        <div class="review-content">
          {{ review.content }}
        </div>
        <div class="review-meta">
          By {{ review.users.username }} on {{ review.timestamp.strftime('%Y-%m-%d') }}
          {% if review.ride %}| <strong>Ride:</strong> {{ review.ride.name }} {% endif %}
          {% if review.park %}| <strong>Park:</strong> {{ review.park.name }} {% endif %}
        </div>
      </div>
      {% if review.user_id == session.get('user_id') %}
        <div class="review-actions-row">
          <a href="{{ url_for('review_page', edit_id=review.id) }}" class="review-action-btn-2024 review-action-btn-edit">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon-pencil" width="23" height="23" viewBox="0 0 24 24" fill="none" stroke="#2070be" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
            Edit
          </a>
          <form action="{{ url_for('delete_review', review_id=review.id) }}" method="POST" class="d-inline">
            {{ form.csrf_token }}
            <button type="submit" class="review-action-btn-2024 review-action-btn-delete"
              onclick="return confirm('Are you sure you want to delete this?');">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon-trash" width="23" height="23" viewBox="0 0 24 24" fill="none" stroke="#d43d3d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
              Delete
            </button>
          </form>
        </div>
      {% endif %}
    </div>
  {% else %}
    <p>No reviews yet.</p>
  {% endfor %}
</div>
{% endblock %}